resources:
  jobs:
    Walden_End_2_End:
      name: Walden End 2 End
      email_notifications:
        on_failure:
          - casey@ourresearch.org
          - artem@ourresearch.org
      schedule:
        quartz_cron_expression: 18 30 22 * * ?
        timezone_id: UTC
        pause_status: PAUSED
      tasks:
        - task_key: Crossref_Ingest_DLT
          pipeline_task:
            pipeline_id: 7def27a3-968c-4b1a-864b-0fc308756721
            full_refresh: false
        - task_key: DataCite_Ingest_DLT
          pipeline_task:
            pipeline_id: e5d95673-98e3-47db-8630-48a7739304cc
            full_refresh: false
        - task_key: Landing_Page_Ingest_DLT
          pipeline_task:
            pipeline_id: ff5e63c2-b1b8-49c2-a7c0-2ee246e89e69
            full_refresh: false
        - task_key: Mag_Ingest_DLT
          pipeline_task:
            pipeline_id: 38cc5493-8d83-48f1-87f5-95c8c80938ac
            full_refresh: false
        - task_key: PDF_Ingest_DLT
          pipeline_task:
            pipeline_id: 4b35274b-82f2-41f8-aa4a-87890d282134
            full_refresh: false
        - task_key: PubMed_Ingest_DLT
          pipeline_task:
            pipeline_id: d327518b-e3e0-484c-a214-c7326f3e51fe
            full_refresh: false
        - task_key: Repos_Ingest_DLT
          pipeline_task:
            pipeline_id: fcd1ea61-2e07-433b-90ad-b3b0a0960158
            full_refresh: false
          max_retries: 3
          min_retry_interval_millis: 300000
          retry_on_timeout: true
          timeout_seconds: 3600
        - task_key: Union
          depends_on:
            - task_key: Crossref_Ingest_DLT
            - task_key: PubMed_Ingest_DLT
            - task_key: Mag_Ingest_DLT
            - task_key: Repos_Ingest_DLT
            - task_key: PDF_Ingest_DLT
            - task_key: DataCite_Ingest_DLT
          pipeline_task:
            pipeline_id: bd9dfc4f-7b7f-42a2-b01b-8101c5ab19d5
            full_refresh: false
        - task_key: Crossref_Super_Authorships
          depends_on:
            - task_key: Union
          notebook_task:
            notebook_path: notebooks/end2end/CreateCrossrefSuperAuthorships
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: Repo_Super_Authorships
          depends_on:
            - task_key: Union
          notebook_task:
            notebook_path: notebooks/end2end/CreateRepoSuperAuthorships
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: Superlocations
          depends_on:
            - task_key: Repo_Super_Authorships
            - task_key: Crossref_Super_Authorships
          notebook_task:
            notebook_path: notebooks/end2end/CreateSuperLocations
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: Locations_with_Sources
          depends_on:
            - task_key: Superlocations
          notebook_task:
            notebook_path: notebooks/end2end/CreateLocationsWithSources
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: Locations_Mapped
          depends_on:
            - task_key: Locations_with_Sources
          notebook_task:
            notebook_path: notebooks/end2end/CreateLocationsMapped
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: parse_referenced_works
          depends_on:
            - task_key: Locations_Mapped
          notebook_task:
            notebook_path: notebooks/parsing/parse_work_references
            source: GIT
            warehouse_id: 3996dc0a9b183ce3
        - task_key: Works_Base
          depends_on:
            - task_key: parse_referenced_works
          notebook_task:
            notebook_path: notebooks/end2end/CreateWorksBase
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: Parsed_Author_Names
          depends_on:
            - task_key: Works_Base
          notebook_task:
            notebook_path: notebooks/end2end/CreateParsedNamesLookup
            source: GIT
        - task_key: Prepare_Affiliation_Strings
          depends_on:
            - task_key: Works_Base
          notebook_task:
            notebook_path: notebooks/end2end/PrepareAffiliationStrings
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: Institutions_Frontfill
          depends_on:
            - task_key: Prepare_Affiliation_Strings
          run_job_task:
            job_id: 462221738638096
        - task_key: Topics_Frontfill
          depends_on:
            - task_key: Works_Base
          run_job_task:
            job_id: 751459553624380
        - task_key: Author_Matching
          depends_on:
            - task_key: Parsed_Author_Names
            - task_key: Institutions_Frontfill
            - task_key: Topics_Frontfill
          notebook_task:
            notebook_path: notebooks/end2end/UpdateWorkAuthorAffiliations
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: Authors_and_Affiliations
          depends_on:
            - task_key: Author_Matching
          notebook_task:
            notebook_path: notebooks/end2end/UpdateWorkAuthorships
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: Works_Enriched
          depends_on:
            - task_key: Authors_and_Affiliations
          notebook_task:
            notebook_path: notebooks/end2end/CreateWorksEnriched
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: Wunpaywall
          depends_on:
            - task_key: Works_Enriched
          notebook_task:
            notebook_path: notebooks/end2end/CreateWunpaywall
            source: GIT
            warehouse_id: 4d37bf76372a2901
        - task_key: IS_PROD
          depends_on:
            - task_key: Wunpaywall
          condition_task:
            op: EQUAL_TO
            left: "{{job.parameters.env}}"
            right: prod
        - task_key: Wunpaywal_Data_Feed
          depends_on:
            - task_key: IS_PROD
              outcome: "true"
          notebook_task:
            notebook_path: notebooks/end2end/WunpaywallDataFeed
            source: GIT
          job_cluster_key: Wunpaywall_DataFeed_Job_Cluster
        - task_key: Wunpaywall_Full_Snapshot
          depends_on:
            - task_key: IS_PROD
              outcome: "true"
          notebook_task:
            notebook_path: notebooks/snapshot/export_wunpaywall
            source: GIT
          job_cluster_key: Wunpaywall_DataFeed_Job_Cluster
        - task_key: Wunpaywall_to_OpenAlex_DB
          depends_on:
            - task_key: IS_PROD
              outcome: "true"
          notebook_task:
            notebook_path: notebooks/end2end/WunpaywallToOpenAlexDB
            source: GIT
          job_cluster_key: Wunpaywall_DataFeed_Job_Cluster
        - task_key: Sync_to_Elasticsearch
          depends_on:
            - task_key: Works_Enriched
          notebook_task:
            notebook_path: notebooks/elastic/sync_works
            source: GIT
          job_cluster_key: Sync_to_Elasticsearch_cluster
      job_clusters:
        - job_cluster_key: Sync_to_Elasticsearch_cluster
          new_cluster:
            spark_version: 16.4.x-scala2.12
            aws_attributes:
              first_on_demand: 1
              availability: SPOT_WITH_FALLBACK
              zone_id: us-east-1f
              spot_bid_price_percent: 100
              ebs_volume_count: 0
            node_type_id: rgd-fleet.12xlarge
            spark_env_vars:
              PYSPARK_PYTHON: /databricks/python3/bin/python3
            enable_elastic_disk: true
            data_security_mode: USER_ISOLATION
            runtime_engine: STANDARD
            num_workers: 2
        - job_cluster_key: Wunpaywall_DataFeed_Job_Cluster
          new_cluster:
            cluster_name: ""
            spark_version: 16.4.x-scala2.13
            aws_attributes:
              first_on_demand: 1
              zone_id: auto
              spot_bid_price_percent: 100
            node_type_id: rd-fleet.8xlarge
            enable_elastic_disk: true
            data_security_mode: DATA_SECURITY_MODE_DEDICATED
            runtime_engine: STANDARD
            kind: CLASSIC_PREVIEW
            is_single_node: true
      git_source:
        git_url: https://github.com/ourresearch/openalex-walden.git
        git_provider: gitHub
        git_branch: main
      queue:
        enabled: true
      parameters:
        - name: env
          default: prod
        - name: env_suffix
          default: ""
        - name: openalex
          default: openalex
        - name: force_large_load
          default: "false"
      environments:
        - environment_key: Default
          spec:
            environment_version: "4"
      performance_target: PERFORMANCE_OPTIMIZED
